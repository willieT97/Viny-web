<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Viny Map – Custom Icons</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // 1) Initialize the map centered on Dublin
    const map = L.map('map').setView([53.3498, -6.2603], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 2) Define custom marker icons pointing to your own images
    const openIcon = L.icon({
      iconUrl: 'images/open-session.png',   // your custom fiddle icon
      iconSize: [32, 32],                    // adjust if your PNG is a different size
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const closedIcon = L.icon({
      iconUrl: 'images/closed-session.png', // your mic icon 
      iconSize: [16, 36],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const gigIcon = L.icon({
      iconUrl: 'images/gig.png',            // your drums gig icon
      iconSize: [48, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    // 3) Your Sheet.best endpoint
    const sheetURL = 'https://api.sheetbest.com/sheets/1c3ecc0a-2eb8-4b82-b1e4-b5cdb51f4bc7';
    // 4) Your OpenCage API key
    const apiKey = '1bce004158a94773afe52570c225384a';

    // 5) Fetch the JSON from Sheet.best and place markers via OpenCage
    fetch(sheetURL)
      .then(response => {
        if (!response.ok) throw new Error(`Sheet fetch error: ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log("Sheet data:", data);

        data.forEach((row, i) => {
          console.log(`Row ${i}:`, row);

          const name    = row.Name || 'Unnamed';
          const type    = row.Type || '';
          const date    = row.Date || '';
          const eircode = (row.Eircode || '').trim();
          if (!eircode) {
            console.warn(`Skipping row ${i} (no Eircode)`);
            return;
          }

          // Real geocoding for each Eircode
          fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(eircode)}&key=${apiKey}`)
            .then(res => res.json())
            .then(geoData => {
              if (!geoData.results || !geoData.results.length) {
                console.warn(`No coords for Eircode "${eircode}"`);
                return;
              }
              const { lat, lng } = geoData.results[0].geometry;

              let chosenIcon;
              const typeLower = type.toLowerCase();
              if (typeLower.includes("open")) {
                chosenIcon = openIcon;
              } else if (typeLower.includes("closed")) {
                chosenIcon = closedIcon;
              } else {
                chosenIcon = gigIcon;
              }

              L.marker([lat, lng], { icon: chosenIcon })
               .addTo(map)
               .bindPopup(`<strong>${name}</strong><br>Type: ${type}<br>Date: ${date}`);
            })
            .catch(err => console.error('Geocode error:', err));
        });
      })
      .catch(err => console.error('Fetch or parse error:', err));
  </script>
</body>
</html>

